# Version 2.0.0 Change Log

**Release Date:** 2025-11-17  
**Status:** stable

## Description
Major improvements in code quality, performance, and developer experience.

## What's New
- Enhanced error handling with logging
- Route pattern caching for performance
- Comprehensive PHPDoc documentation
- Complete type hints throughout codebase
- Integrated logging system
- Proper resource management

## Improvements
- Route caching reduces compilation overhead
- Comprehensive error logging for debugging
- Type safety improves code reliability
- Better resource cleanup prevents memory leaks

## Features

### Enhanced Error Handling
- **Description:** Comprehensive try-catch blocks with detailed logging using Logger class
- **Icon:** `bi-exclamation-triangle`
- **Color:** `danger`
- **Code Example:**
  ```php
  Logger::error("Message", ['context' => 'data']);
  ```

### Route Pattern Caching
- **Description:** Compiled route patterns are cached to avoid recompiling on every request
- **Icon:** `bi-lightning`
- **Color:** `warning`
- **Code Example:**
  ```php
  private static $compiledRoutes = [];
  ```

### Comprehensive Documentation
- **Description:** All classes, methods, and functions now have PHPDoc comments
- **Icon:** `bi-file-text`
- **Color:** `info`
- **Code Example:**
  ```php
  /** @param string $name Route name */
  ```

### Type Safety
- **Description:** Added type hints throughout the codebase for better IDE support
- **Icon:** `bi-shield-check`
- **Color:** `success`
- **Code Example:**
  ```php
  public function find(int $id): ?array
  ```

### Resource Management
- **Description:** Proper cleanup of database connections and result sets
- **Icon:** `bi-recycle`
- **Color:** `primary`
- **Code Example:**
  ```php
  $result->free(); $db->close();
  ```

### Improved Query Building
- **Description:** Separated query building logic into dedicated methods
- **Icon:** `bi-code-square`
- **Color:** `dark`
- **Code Example:**
  ```php
  private static function buildQuery(): string
  ```

## Comparison (vs Previous Version)

| Feature | Previous Version | Current Version |
|---------|-----------------|-----------------|
| Error Handling | Basic | Comprehensive with logging |
| Route Caching | None | Pattern caching |
| Code Documentation | Minimal | Full PHPDoc |
| Type Hints | Partial | Complete |
| Logging System | Not used | Integrated throughout |
| Resource Cleanup | Missing | Proper cleanup |
| Query Building | Inline | Separated methods |
| Input Validation | Basic | Enhanced with logging |
| Database Error Handling | Basic echo | Exception-based |
| Controller Validation | None | File & class checks |

## Changelog by Component

### Core/App.php
- Added comprehensive error handling with try-catch blocks
- Integrated Logger for error tracking
- Added controller file and class existence validation
- Added method existence checks before execution
- Improved error messages with context
- Added PHPDoc comments for all methods
- Added type hints for better type safety

### .htaccess
- Fixed RewriteBase configuration from `/php-framework/` to `/` for proper routing
- Resolves internal server errors on login and other routes

### App/Controllers/Html.php
- Fixed login() method to accept parameters array for router compatibility
- Ensures proper method signature matching with router dispatch

### Core/Router.php
- Added route pattern caching to improve performance
- Compiled patterns stored in static cache
- Cache cleared only on route reload
- Added comprehensive PHPDoc documentation
- Improved code comments for clarity

### Core/Database.php
- Separated query building into buildQuery() method
- Added proper error handling with exceptions
- Integrated Logger for database errors
- Added result set cleanup (free())
- Improved connection error handling
- Added type hints throughout
- Added comprehensive PHPDoc comments

### App/Models/User.php
- Added try-catch blocks for all methods
- Integrated Logger for error tracking
- Added input validation before operations
- Proper database connection cleanup
- Better error messages with context
- Added return type hints
- Added comprehensive documentation

### App/Controllers/Api.php
- Added comprehensive error handling
- Integrated Logger throughout
- Added early returns for better flow
- Improved error messages
- Added file upload validation
- Better fallback handling for users endpoint
- Added PHPDoc comments

## Tutorials

### Routing
#### Section: Defining Routes
- **Heading:** Defining Routes
- **Content:** Routes are defined in `routes.php`. Each route needs a method, path, controller, and action.
- **Code:**
  ```php
  <?php
  
  return [
      'home' => [
          'method' => 'GET',
          'path' => '/',
          'controller' => 'html',
          'action' => 'index',
      ],
      'user.show' => [
          'method' => 'GET',
          'path' => '/user/{id}',
          'controller' => 'user',
          'action' => 'show',
      ],
      'user.store' => [
          'method' => 'POST',
          'path' => '/user',
          'controller' => 'user',
          'action' => 'store',
          'middleware' => ['csrf', 'auth']
      ],
  ];
  ```
- **Explanation:**
  - `method`: HTTP method (GET, POST, PUT, DELETE)
  - `path`: URL pattern with optional parameters like `{id}`
  - `controller`: Controller class name (without .php extension)
  - `action`: Method name in the controller
  - `middleware`: Array of middleware to run before the action (optional)

#### Section: Route Parameters
- **Heading:** Route Parameters
- **Content:** Routes can accept parameters in the URL path using curly braces.
- **Code:**
  ```php
  <?php
  
  return [
      'post.show' => [
          'method' => 'GET',
          'path' => '/post/{id}',
          'controller' => 'post',
          'action' => 'show',
      ],
  ];
  ```
- **Explanation:**
  - Parameters are defined using `{param}` syntax
  - Parameters are passed to the controller action as an array
  - Access parameters using `$params[0]`, `$params[1]`, etc.

### Database
#### Section: Basic Queries
- **Heading:** Basic Queries
- **Content:** The query builder provides a fluent interface for building database queries.
- **Code:**
  ```php
  <?php
  
  use Connection\Database;
  use Core\Logger;
  
  try {
      $users = Database::table('users')->get();
      
      $activeUsers = Database::table('users')
          ->where('status = "active"')
          ->orderBy('created_at DESC')
          ->limit(10)
          ->get();
  } catch (\Exception $e) {
      Logger::error("Database query failed", ['error' => $e->getMessage()]);
  }
  ```
- **Explanation:**
  - `table('name')`: Sets the table name
  - `where('condition')`: Adds WHERE clause
  - `orderBy('column')`: Adds ORDER BY clause
  - `limit(number)`: Limits the number of results
  - `get()`: Executes the query and returns array of results
  - **New in v2.0.0:** Enhanced error handling with Logger integration

#### Section: Using Models
- **Heading:** Using Models
- **Content:** Models provide a cleaner interface for database operations with built-in error handling.
- **Code:**
  ```php
  <?php
  
  class UserController extends Controller
  {
      public function show($params)
      {
          $id = $params[0] ?? null;
          
          // Find user by ID with automatic error handling
          $user = User::find($id);
          
          if (!$user) {
              return $this->error('User not found', 404);
          }
          
          return $this->json($user);
      }
  }
  ```
- **Explanation:**
  - Models include built-in error handling and logging
  - Methods return null on failure instead of throwing exceptions
  - All database errors are automatically logged

### Validation
#### Section: Validating Input
- **Heading:** Validating Input
- **Content:** Use the validator to validate form data with rules. Enhanced with better error handling in v2.0.0.
- **Code:**
  ```php
  <?php
  
  use Core\Logger;
  
  try {
      $validator = $this->validate($_POST, [
          'name' => 'required|min:3|max:50',
          'email' => 'required|email|unique:users',
          'password' => 'required|min:8|confirmed',
      ]);
      
      if ($validator->fails()) {
          flash('errors', $validator->errors());
          return $this->back();
      }
      
      $data = $validator->validated();
  } catch (\Exception $e) {
      Logger::error("Validation failed", ['error' => $e->getMessage()]);
  }
  ```
- **Explanation:**
  - `required`: Field must be present and not empty
  - `min:X`: Minimum length for strings
  - `max:X`: Maximum length for strings
  - `email`: Must be valid email format
  - `unique:table`: Must be unique in the specified table
  - **New in v2.0.0:** Enhanced error logging for validation failures

### Views
#### Section: Rendering Views
- **Heading:** Rendering Views
- **Content:** Use the `view()` method to render templates with data.
- **Code:**
  ```php
  <?php
  
  class UserController extends Controller
  {
      protected $layout = 'main'; // Default layout
      
      public function show($params)
      {
          $user = User::find($params[0]);
          
          // Render view with data
          $this->view('user/show', [
              'user' => $user,
              'title' => 'User Profile'
          ]);
      }
  }
  ```
- **Explanation:**
  - Layout files are stored in `app/views/layouts/`
  - The view content is inserted into `$content` variable
  - You can set a default layout in the controller with `protected $layout`
  - Override layout per view by passing it as third parameter

### CSRF
#### Section: Adding CSRF Token to Forms
- **Heading:** Adding CSRF Token to Forms
- **Content:** Protect your forms from CSRF attacks by including a CSRF token.
- **Code:**
  ```html
  <form method="POST" action="<?= route('user.store') ?>">
      <?= csrf_field() ?>
      
      <input type="text" name="name" required>
      <button type="submit">Submit</button>
  </form>
  ```
- **Explanation:**
  - `csrf_field()`: Generates a hidden input with the CSRF token automatically
  - The token is stored in the session and validated on each POST request
  - If the token doesn't match, the request is rejected
  - Tokens are regenerated periodically for security

#### Section: Protecting Routes
- **Heading:** Protecting Routes
- **Content:** Add CSRF middleware to routes that handle form submissions.
- **Code:**
  ```php
  <?php
  
  return [
      'user.store' => [
          'method' => 'POST',
          'path' => '/user',
          'controller' => 'user',
          'action' => 'store',
          'middleware' => ['csrf']  // CSRF protection
      ],
  ];
  ```
- **Explanation:**
  - Add `'middleware' => ['csrf']` to protect routes
  - Middleware runs before the controller action
  - Automatically validates CSRF token for POST/PUT/DELETE requests

### Upload
#### Section: Handling File Uploads
- **Heading:** Handling File Uploads
- **Content:** Use the Upload class to handle file uploads with validation. Enhanced error handling in v2.0.0.
- **Code:**
  ```php
  <?php
  
  use Core\Upload;
  use Core\Logger;
  
  try {
      $file = Upload::make('file')
          ->allowed(['jpg', 'jpeg', 'png', 'pdf'])
          ->maxSize(5242880) // 5MB in bytes
          ->path('storage/uploads')
          ->store();
      
      return $this->success([
          'filename' => $file,
          'url' => assets('uploads/' . $file)
      ], 'File uploaded successfully');
      
  } catch (\Exception $e) {
      Logger::error("File upload failed", ['error' => $e->getMessage()]);
      return $this->error($e->getMessage(), 400);
  }
  ```
- **Explanation:**
  - `make('field')`: Specify the file input name from the form
  - `allowed(['ext1', 'ext2'])`: Set allowed file extensions
  - `maxSize(bytes)`: Set maximum file size (1MB = 1048576 bytes)
  - `path('directory')`: Set upload directory relative to project root
  - `store()`: Saves the file and returns the filename
  - **New in v2.0.0:** Enhanced error handling with Logger integration

## Notes
This version focuses on code quality, performance, and developer experience. All changes are backward compatible with v1.0.0.

### Recent Fixes (Post-Release)
- Fixed RewriteBase in .htaccess to resolve routing issues
- Updated login controller method to properly accept router parameters

